--[[
    Murder Mystery 2 Hack GUI - Premium Version
    Features:
    - ESP đã sửa (hiển thị đầy đủ khung màu)
    - Giao diện đẹp với 2 màu chủ đạo
    - Bo góc mượt mà
    - Đã xóa TPTool theo yêu cầu
]]

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Màu sắc chủ đạo
local PrimaryColor = Color3.fromRGB(10, 25, 50)
local SecondaryColor = Color3.fromRGB(25, 80, 150)
local AccentColor = Color3.fromRGB(0, 162, 255)

-- Màu ESP
local MurdererColor = Color3.fromRGB(255, 50, 50)  -- Đỏ
local SheriffColor = Color3.fromRGB(50, 50, 255)   -- Xanh dương
local InnocentColor = Color3.fromRGB(50, 255, 50) -- Xanh lá

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- Tạo GUI với bo góc
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MM2Premium_"..tostring(math.random(1000,9999))
ScreenGui.Parent = CoreGui
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 320, 0, 400)
MainFrame.Position = UDim2.new(0.5, -160, 0.5, -200)
MainFrame.BackgroundColor3 = PrimaryColor
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true

-- Bo góc cho MainFrame
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

local UIStroke = Instance.new("UIStroke")
UIStroke.Color = SecondaryColor
UIStroke.Thickness = 2
UIStroke.Parent = MainFrame

MainFrame.Parent = ScreenGui

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 40)
TitleBar.Position = UDim2.new(0, 0, 0, 0)
TitleBar.BackgroundColor3 = SecondaryColor
TitleBar.BorderSizePixel = 0

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 8)
TitleCorner.Parent = TitleBar

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -20, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Text = "PREMIUM MM2 HACK"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.Parent = TitleBar

TitleBar.Parent = MainFrame

-- Tab Buttons
local TabButtons = Instance.new("Frame")
TabButtons.Size = UDim2.new(1, -20, 0, 30)
TabButtons.Position = UDim2.new(0, 10, 0, 45)
TabButtons.BackgroundTransparency = 1
TabButtons.Parent = MainFrame

local ESPTabButton = Instance.new("TextButton")
ESPTabButton.Size = UDim2.new(0.5, -5, 1, 0)
ESPTabButton.Position = UDim2.new(0, 0, 0, 0)
ESPTabButton.BackgroundColor3 = SecondaryColor
ESPTabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ESPTabButton.Text = "ESP"
ESPTabButton.Font = Enum.Font.GothamBold
ESPTabButton.TextSize = 14

local TabCorner = Instance.new("UICorner")
TabCorner.CornerRadius = UDim.new(0, 6)
TabCorner.Parent = ESPTabButton

ESPTabButton.Parent = TabButtons

local MovementTabButton = Instance.new("TextButton")
MovementTabButton.Size = UDim2.new(0.5, -5, 1, 0)
MovementTabButton.Position = UDim2.new(0.5, 5, 0, 0)
MovementTabButton.BackgroundColor3 = PrimaryColor
MovementTabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MovementTabButton.Text = "MOVEMENT"
MovementTabButton.Font = Enum.Font.GothamBold
MovementTabButton.TextSize = 14

local MovementCorner = Instance.new("UICorner")
MovementCorner.CornerRadius = UDim.new(0, 6)
MovementCorner.Parent = MovementTabButton

MovementTabButton.Parent = TabButtons

-- Content Frame
local ContentFrame = Instance.new("Frame")
ContentFrame.Size = UDim2.new(1, -20, 1, -85)
ContentFrame.Position = UDim2.new(0, 10, 0, 80)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = MainFrame

-- ESP Tab
local ESPFrame = Instance.new("Frame")
ESPFrame.Size = UDim2.new(1, 0, 1, 0)
ESPFrame.BackgroundTransparency = 1
ESPFrame.Visible = true
ESPFrame.Parent = ContentFrame

local function CreateButton(text, yPos)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1, 0, 0, 35)
    button.Position = UDim2.new(0, 0, 0, yPos)
    button.BackgroundColor3 = SecondaryColor
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Text = text
    button.Font = Enum.Font.GothamBold
    button.TextSize = 14
    button.AutoButtonColor = false
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 6)
    buttonCorner.Parent = button
    
    local buttonStroke = Instance.new("UIStroke")
    buttonStroke.Color = AccentColor
    buttonStroke.Thickness = 1
    buttonStroke.Parent = button
    
    -- Hiệu ứng hover
    button.MouseEnter:Connect(function()
        game:GetService("TweenService"):Create(
            button,
            TweenInfo.new(0.2),
            {BackgroundColor3 = AccentColor}
        ):Play()
    end)
    
    button.MouseLeave:Connect(function()
        game:GetService("TweenService"):Create(
            button,
            TweenInfo.new(0.2),
            {BackgroundColor3 = SecondaryColor}
        ):Play()
    end)
    
    return button
end

local ESPToggle = CreateButton("ESP: OFF", 10)
ESPToggle.Parent = ESPFrame

local AimbotToggle = CreateButton("AIMBOT: OFF", 55)
AimbotToggle.Parent = ESPFrame

local SpectateButton = CreateButton("SPECTATE PLAYER", 100)
SpectateButton.Parent = ESPFrame

local SpectateList = Instance.new("ScrollingFrame")
SpectateList.Size = UDim2.new(1, 0, 0, 150)
SpectateList.Position = UDim2.new(0, 0, 0, 145)
SpectateList.BackgroundColor3 = PrimaryColor
SpectateList.BackgroundTransparency = 0.5
SpectateList.Visible = false
SpectateList.Parent = ESPFrame

local ListCorner = Instance.new("UICorner")
ListCorner.CornerRadius = UDim.new(0, 6)
ListCorner.Parent = SpectateList

-- Movement Tab
local MovementFrame = Instance.new("Frame")
MovementFrame.Size = UDim2.new(1, 0, 1, 0)
MovementFrame.BackgroundTransparency = 1
MovementFrame.Visible = false
MovementFrame.Parent = ContentFrame

local FlyToggle = CreateButton("FLY: OFF", 10)
FlyToggle.Parent = MovementFrame

local AntiAFKToggle = CreateButton("ANTI-AFK: ON", 55)
AntiAFKToggle.Parent = MovementFrame

-- Variables
local ESPEnabled = false
local AimbotEnabled = false
local FlyEnabled = false
local AntiAFKEnabled = true
local Spectating = false
local SpectatingPlayer = nil

local ESPBoxes = {}
local ESPNames = {}
local ESPTracers = {}

-- Fixed GetPlayerRole function
local function GetPlayerRole(player)
    if player == LocalPlayer then return "Local" end
    
    -- Check Backpack first
    if player:FindFirstChild("Backpack") then
        for _, item in pairs(player.Backpack:GetChildren()) do
            if string.lower(item.Name) == "knife" then
                return "Murderer"
            elseif string.lower(item.Name) == "gun" then
                return "Sheriff"
            end
        end
    end
    
    -- Check Character if not found in Backpack
    if player.Character then
        -- Check for tools in hand
        for _, tool in pairs(player.Character:GetChildren()) do
            if tool:IsA("Tool") then
                if string.lower(tool.Name) == "knife" then
                    return "Murderer"
                elseif string.lower(tool.Name) == "gun" then
                    return "Sheriff"
                end
            end
        end
        
        -- Check for special role indicators
        if player.Character:FindFirstChild("Role") then
            local role = player.Character.Role.Value
            if string.lower(role) == "murderer" then
                return "Murderer"
            elseif string.lower(role) == "sheriff" then
                return "Sheriff"
            end
        end
    end
    
    return "Innocent"
end

-- Fixed CreateESP function (đảm bảo hiển thị khung màu)
local function CreateESP(player)
    if player == LocalPlayer then return end
    if not player.Character then return end
    
    local humanoidRootPart = player.Character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    -- Remove old ESP if exists
    RemoveESP(player)
    
    local role = GetPlayerRole(player)
    local color = InnocentColor
    
    if role == "Murderer" then
        color = MurdererColor
    elseif role == "Sheriff" then
        color = SheriffColor
    end
    
    -- Box ESP (khung màu)
    local box = Instance.new("BoxHandleAdornment")
    box.Name = "ESPBox_" .. player.Name
    box.Adornee = humanoidRootPart
    box.AlwaysOnTop = true
    box.ZIndex = 5
    box.Size = Vector3.new(3, 5, 1)
    box.Color3 = color
    box.Transparency = 0.3 -- Giảm độ trong suốt để thấy rõ hơn
    box.Parent = humanoidRootPart
    
    -- Name Tag
    local nameTag = Instance.new("BillboardGui")
    nameTag.Name = "ESPName_" .. player.Name
    nameTag.Adornee = humanoidRootPart
    nameTag.AlwaysOnTop = true
    nameTag.Size = UDim2.new(0, 200, 0, 50)
    nameTag.StudsOffset = Vector3.new(0, 3.5, 0)
    nameTag.Parent = humanoidRootPart
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 1, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = player.Name .. "\n[" .. role .. "]"
    nameLabel.TextColor3 = color
    nameLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    nameLabel.TextStrokeTransparency = 0
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextSize = 14
    nameLabel.Parent = nameTag
    
    -- Tracer
    local tracer = Instance.new("Frame")
    tracer.Name = "ESPTracer_" .. player.Name
    tracer.BackgroundColor3 = color
    tracer.BorderSizePixel = 0
    tracer.Size = UDim2.new(0, 2, 0, 2)
    tracer.AnchorPoint = Vector2.new(0.5, 0.5)
    tracer.Position = UDim2.new(0.5, 0, 1, 0)
    tracer.Parent = ScreenGui
    
    -- Save to tables
    ESPBoxes[player] = box
    ESPNames[player] = nameTag
    ESPTracers[player] = tracer
    
    -- Connect character change event
    player.CharacterAdded:Connect(function(character)
        task.wait(1) -- Wait for character to fully load
        if ESPEnabled then
            CreateESP(player)
        end
    end)
end

local function RemoveESP(player)
    if ESPBoxes[player] then
        ESPBoxes[player]:Destroy()
        ESPBoxes[player] = nil
    end
    if ESPNames[player] then
        ESPNames[player]:Destroy()
        ESPNames[player] = nil
    end
    if ESPTracers[player] then
        ESPTracers[player]:Destroy()
        ESPTracers[player] = nil
    end
end

local function UpdateESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if ESPEnabled then
                -- Recheck role each update
                local role = GetPlayerRole(player)
                
                -- If ESP exists, update color based on new role
                if ESPBoxes[player] then
                    local color = InnocentColor
                    if role == "Murderer" then color = MurdererColor
                    elseif role == "Sheriff" then color = SheriffColor end
                    
                    ESPBoxes[player].Color3 = color
                    ESPNames[player].TextLabel.TextColor3 = color
                    ESPNames[player].TextLabel.Text = player.Name .. "\n[" .. role .. "]"
                    ESPTracers[player].BackgroundColor3 = color
                else
                    CreateESP(player)
                end
            else
                RemoveESP(player)
            end
        end
    end
end

local function UpdateTracers()
    for player, tracer in pairs(ESPTracers) do
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local rootPart = player.Character.HumanoidRootPart
            local position, onScreen = Workspace.CurrentCamera:WorldToViewportPoint(rootPart.Position)
            
            if onScreen then
                tracer.Visible = true
                tracer.Position = UDim2.new(0, position.X, 0, position.Y)
                
                -- Update size based on distance
                local distance = (LocalPlayer.Character.HumanoidRootPart.Position - rootPart.Position).Magnitude
                local size = math.clamp(1000 / distance, 2, 6)
                tracer.Size = UDim2.new(0, size, 0, size)
            else
                tracer.Visible = false
            end
        else
            tracer.Visible = false
        end
    end
end

local function CheckRolesPeriodically()
    while task.wait(2) do
        if ESPEnabled then
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and ESPBoxes[player] then
                    local role = GetPlayerRole(player)
                    local color = InnocentColor
                    if role == "Murderer" then color = MurdererColor
                    elseif role == "Sheriff" then color = SheriffColor end
                    
                    ESPBoxes[player].Color3 = color
                    ESPNames[player].TextLabel.TextColor3 = color
                    ESPNames[player].TextLabel.Text = player.Name .. "\n[" .. role .. "]"
                    ESPTracers[player].BackgroundColor3 = color
                end
            end
        end
    end
end

-- Fixed Spectate function
local function SpectatePlayer(player)
    if Spectating and SpectatingPlayer == player then
        -- Stop spectating
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            Workspace.CurrentCamera.CameraSubject = LocalPlayer.Character.Humanoid
        else
            Workspace.CurrentCamera.CameraSubject = nil
        end
        Spectating = false
        SpectatingPlayer = nil
        SpectateButton.Text = "SPECTATE PLAYER"
    else
        -- Start spectating
        if player and player.Character and player.Character:FindFirstChild("Humanoid") then
            Workspace.CurrentCamera.CameraSubject = player.Character.Humanoid
            Spectating = true
            SpectatingPlayer = player
            SpectateButton.Text = "STOP SPECTATING (" .. player.Name .. ")"
            
            -- Auto stop when player is removed
            local connection
            connection = player.CharacterRemoving:Connect(function()
                if SpectatingPlayer == player then
                    SpectatePlayer(player) -- Stop spectating
                    connection:Disconnect()
                end
            end)
        end
    end
end

local function PopulateSpectateList()
    SpectateList:ClearAllChildren()
    
    local yOffset = 0
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local button = Instance.new("TextButton")
            button.Size = UDim2.new(1, -10, 0, 30)
            button.Position = UDim2.new(0, 5, 0, yOffset)
            button.BackgroundColor3 = SecondaryColor
            button.TextColor3 = Color3.fromRGB(255, 255, 255)
            button.Text = player.Name .. " (" .. GetPlayerRole(player) .. ")"
            button.Font = Enum.Font.Gotham
            button.TextSize = 14
            
            local buttonCorner = Instance.new("UICorner")
            buttonCorner.CornerRadius = UDim.new(0, 4)
            buttonCorner.Parent = button
            
            button.MouseButton1Click:Connect(function()
                SpectatePlayer(player)
                SpectateList.Visible = false
            end)
            
            button.Parent = SpectateList
            yOffset = yOffset + 35
        end
    end
    
    SpectateList.CanvasSize = UDim2.new(0, 0, 0, yOffset)
end

-- Aimbot function
local function Aimbot()
    if not AimbotEnabled or not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("Humanoid") then return end
    
    local closestPlayer = nil
    local closestDistance = math.huge
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local role = GetPlayerRole(player)
            if role == "Murderer" then
                local distance = (LocalPlayer.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = player
                end
            end
        end
    end
    
    if closestPlayer then
        local target = closestPlayer.Character.HumanoidRootPart
        Workspace.CurrentCamera.CFrame = CFrame.new(Workspace.CurrentCamera.CFrame.Position, target.Position)
    end
end

-- Fly function
local function Fly()
    if not FlyEnabled or not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    
    local rootPart = LocalPlayer.Character.HumanoidRootPart
    local control = {w = false, a = false, s = false, d = false, space = false, shift = false}
    
    local connections = {
        UserInputService.InputBegan:Connect(function(input, processed)
            if processed then return end
            if input.KeyCode == Enum.KeyCode.W then control.w = true end
            if input.KeyCode == Enum.KeyCode.A then control.a = true end
            if input.KeyCode == Enum.KeyCode.S then control.s = true end
            if input.KeyCode == Enum.KeyCode.D then control.d = true end
            if input.KeyCode == Enum.KeyCode.Space then control.space = true end
            if input.KeyCode == Enum.KeyCode.LeftShift then control.shift = true end
        end),
        
        UserInputService.InputEnded:Connect(function(input, processed)
            if input.KeyCode == Enum.KeyCode.W then control.w = false end
            if input.KeyCode == Enum.KeyCode.A then control.a = false end
            if input.KeyCode == Enum.KeyCode.S then control.s = false end
            if input.KeyCode == Enum.KeyCode.D then control.d = false end
            if input.KeyCode == Enum.KeyCode.Space then control.space = false end
            if input.KeyCode == Enum.KeyCode.LeftShift then control.shift = false end
        end)
    }
    
    local flySpeed = 50
    local flyVelocity = Vector3.new(0, 0, 0)
    
    RunService.Stepped:Connect(function()
        if not FlyEnabled or not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            for _, conn in pairs(connections) do
                conn:Disconnect()
            end
            return
        end
        
        local camera = Workspace.CurrentCamera
        local forward = camera.CFrame.LookVector
        local right = camera.CFrame.RightVector
        local up = Vector3.new(0, 1, 0)
        
        flyVelocity = Vector3.new(0, 0, 0)
        
        if control.w then flyVelocity = flyVelocity + forward end
        if control.a then flyVelocity = flyVelocity - right end
        if control.s then flyVelocity = flyVelocity - forward end
        if control.d then flyVelocity = flyVelocity + right end
        if control.space then flyVelocity = flyVelocity + up end
        if control.shift then flyVelocity = flyVelocity - up end
        
        if flyVelocity.Magnitude > 0 then
            flyVelocity = flyVelocity.Unit * flySpeed
        end
        
        rootPart.Velocity = flyVelocity
        rootPart.AssemblyLinearVelocity = flyVelocity
    end)
end

-- Anti-AFK function
local function AntiAFK()
    if AntiAFKEnabled then
        local VirtualUser = game:GetService("VirtualUser")
        LocalPlayer.Idled:Connect(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end
end

-- Anti-Ban function
local function AntiBan()
    -- Randomize GUI name
    ScreenGui.Name = "PremiumUI_" .. tostring(math.random(10000,99999))
    
    -- Hide GUI with hotkey
    UserInputService.InputBegan:Connect(function(input, processed)
        if input.KeyCode == Enum.KeyCode.RightShift then
            MainFrame.Visible = not MainFrame.Visible
        end
    end)
end

-- Tab Switching
ESPTabButton.MouseButton1Click:Connect(function()
    ESPFrame.Visible = true
    MovementFrame.Visible = false
    ESPTabButton.BackgroundColor3 = SecondaryColor
    MovementTabButton.BackgroundColor3 = PrimaryColor
end)

MovementTabButton.MouseButton1Click:Connect(function()
    ESPFrame.Visible = false
    MovementFrame.Visible = true
    ESPTabButton.BackgroundColor3 = PrimaryColor
    MovementTabButton.BackgroundColor3 = SecondaryColor
end)

-- Toggle Functions
ESPToggle.MouseButton1Click:Connect(function()
    ESPEnabled = not ESPEnabled
    ESPToggle.Text = "ESP: " .. (ESPEnabled and "ON" or "OFF")
    
    if ESPEnabled then
        -- Create ESP for all players
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                CreateESP(player)
            end
        end
        
        -- Start periodic role checking
        task.spawn(CheckRolesPeriodically)
    else
        -- Remove all ESP
        for _, player in pairs(Players:GetPlayers()) do
            RemoveESP(player)
        end
    end
end)

AimbotToggle.MouseButton1Click:Connect(function()
    AimbotEnabled = not AimbotEnabled
    AimbotToggle.Text = "AIMBOT: " .. (AimbotEnabled and "ON" or "OFF")
end)

FlyToggle.MouseButton1Click:Connect(function()
    FlyEnabled = not FlyEnabled
    FlyToggle.Text = "FLY: " .. (FlyEnabled and "ON" or "OFF")
    if FlyEnabled then
        Fly()
    end
end)

AntiAFKToggle.MouseButton1Click:Connect(function()
    AntiAFKEnabled = not AntiAFKEnabled
    AntiAFKToggle.Text = "ANTI-AFK: " .. (AntiAFKEnabled and "ON" or "OFF")
    if AntiAFKEnabled then
        AntiAFK()
    end
end)

SpectateButton.MouseButton1Click:Connect(function()
    SpectateList.Visible = not SpectateList.Visible
    if SpectateList.Visible then
        PopulateSpectateList()
    end
end)

-- Initialize features
AntiAFK()
AntiBan()

-- Main loop
RunService.Stepped:Connect(function()
    if ESPEnabled then
        UpdateTracers()
    end
    
    if AimbotEnabled then
        Aimbot()
    end
end)

-- Player events
Players.PlayerAdded:Connect(function(player)
    if ESPEnabled then
        player.CharacterAdded:Connect(function(character)
            task.wait(1) -- Wait for character to load
            CreateESP(player)
        end)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    RemoveESP(player)
    if SpectatingPlayer == player then
        SpectatePlayer(player) -- Stop spectating if player leaves
    end
end)

-- Initial setup
if ESPEnabled then
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            CreateESP(player)
        end
    end
    task.spawn(CheckRolesPeriodically)
end
